<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>US Choropleth Map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="style.css" />
    <script src="https://d3js.org/d3.v7.min.js" charset="utf-8"></script>
    <script src="//d3js.org/topojson.v1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.13.0/d3-legend.js"></script>
  </head>
  <body>
    <h2 id="title">ðŸŒ‰Infectious Diseases in California</h2>
    <div id="description">Disease</div>
    <select id="qDisease">
      <option value="Amebiasis">Amebiasis</option>
      <option value="Anaplasmosis and Ehrlichiosis">
        Anaplasmosis and Ehrlichiosis
      </option>
      <option value="Babesiosis">Babesiosis</option>
      <option value="Cholera">Cholera</option>
      <option value="Botulism, Other">Botulism, Other</option>
      <option value="Botulism, Foodborne">Botulism, Foodborne</option>
      <option value="Botulism, Wound">Botulism, Wound</option>
      <option value="Brucellosis">Brucellosis</option>
      <option value="Campylobacteriosis">Campylobacteriosis</option>
      <option value="Chlamydia">Chlamydia</option>
      <option value="Ciguatera Fish Poisoning">Ciguatera Fish Poisoning</option>
      <option value="Dengue">Dengue</option>
      <option value="Coccidioidomycosis">Coccidioidomycosis</option>
      <option
        value="Creutzfeldt-Jakob Disease and other Transmissible Spongiform Encephalopathies"
      >
        Creutzfeldt-Jakob Disease and other Transmissible Spongiform
        Encephalopathies
      </option>
      <option value="Cryptosporidiosis">Cryptosporidiosis</option>
      <option value="Cyclosporiasis">Cyclosporiasis</option>
      <option value="Cysticercosis or Taeniasis">
        Cysticercosis or Taeniasis
      </option>
      <option value="E. coli O157">E. coli O157</option>
      <option value="Diphtheria">Diphtheria</option>
      <option value="HIV">HIV</option>
      <option value="Early Syphilis">Early Syphilis</option>
      <option value="Gonorrhea">Gonorrhea</option>
      <option value="E. coli Other STEC (non-O157)">
        E. coli Other STEC (non-O157)
      </option>
      <option value="Giardiasis">Giardiasis</option>
      <option value="Hantavirus Infection">Hantavirus Infection</option>
      <option value="Hepatitis B, Acute">Hepatitis B, Acute</option>
      <option value="Hepatitis E, acute infection">
        Hepatitis E, acute infection
      </option>
      <option value="Hemolytic Uremic Syndrome">
        Hemolytic Uremic Syndrome
      </option>
      <option value="Hepatitis A">Hepatitis A</option>
      <option value="Scombroid Fish Poisoning">Scombroid Fish Poisoning</option>
      <option value="Hepatitis C, Acute">Hepatitis C, Acute</option>
      <option value="Invasive Meningococcal Disease">
        Invasive Meningococcal Disease
      </option>
      <option value="Leprosy">Leprosy</option>
      <option value="Measles">Measles</option>
      <option value="Leptospirosis">Leptospirosis</option>
      <option value="Influenza Death (<65 years of age)">
        Influenza Death (less than 65 years of age)
      </option>
      <option value="Legionellosis">Legionellosis</option>
      <option value="Malaria">Malaria</option>
      <option value="Lyme Disease">Lyme Disease</option>
      <option value="Listeriosis">Listeriosis</option>
      <option value="Pertussis">Pertussis</option>
      <option value="Paralytic Shellfish Poisoning">
        Paralytic Shellfish Poisoning
      </option>
      <option value="Psittacosis">Psittacosis</option>
      <option value="Rabies, human">Rabies, human</option>
      <option value="Mumps">Mumps</option>
      <option value="Q Fever">Q Fever</option>
      <option value="Relapsing Fever">Relapsing Fever</option>
      <option value="Plague, human">Plague, human</option>
      <option value="Rubella">Rubella</option>
      <option value="Salmonellosis">Salmonellosis</option>
      <option value="Tetanus">Tetanus</option>
      <option value="Shiga Toxin Positive Feces (without culture confirmation)">
        Shiga Toxin Positive Feces (without culture confirmation)
      </option>
      <option value="Shigellosis">Shigellosis</option>
      <option value="Spotted Fever Rickettsiosis">
        Spotted Fever Rickettsiosis
      </option>
      <option
        value="Staphylococcus aureus Infection (cases resulting in death or ICU)"
      >
        Staphylococcus aureus Infection (cases resulting in death or ICU)
      </option>
      <option value="Streptococcal Infection (cases in food and dairy workers)">
        Streptococcal Infection (cases in food and dairy workers)
      </option>
      <option value="Tuberculosis">Tuberculosis</option>
      <option value="Toxic Shock Syndrome (Non-Streptococcal)">
        Toxic Shock Syndrome (Non-Streptococcal)
      </option>
      <option value="Vibrio Infection (non-Cholera)">
        Vibrio Infection (non-Cholera)
      </option>
      <option value="Trichinosis">Trichinosis</option>
      <option value="Tularemia">Tularemia</option>
      <option value="Typhoid Fever, case">Typhoid Fever, case</option>
      <option value="Varicella Hospitalizations">
        Varicella Hospitalizations
      </option>
      <option value="Typhus Fever">Typhus Fever</option>
      <option value="Yersiniosis">Yersiniosis</option>
    </select>
    Year
    <select id="qYear">
      <option>2014</option>
      <option>2013</option>
      <option>2012</option>
      <option>2011</option>
      <option>2010</option>
      <option>2009</option>
      <option>2008</option>
      <option>2007</option>
      <option>2006</option>
      <option>2005</option>
      <option>2004</option>
      <option>2003</option>
      <option>2002</option>
      <option>2001</option>
    </select>
    <svg id="canvas"></svg>
    <svg id="legends"></svg>
    <script>
      let canvas = d3.select("#canvas");
      let legends = d3.select("#legends");

      // color
      var domain = [1, 2, 3, 4, 5];
      var labels = ["", "", "", "", ""];
      var range = ["#f9d186", "#f0be72", "#eeb549", "#f2a81d", "#e19506"];
      var colorScale = d3.scaleThreshold().domain(domain).range(range);

      // div for the tooltip
      var tooltip = d3
        .select("body")
        .append("div")
        .attr("class", "tooltip")
        .attr("id", "tooltip")
        .style("opacity", 0);

      function drawMap() {
        canvas
          .selectAll("path")
          .data(californiaData)
          .enter()
          .append("path")
          .attr("d", d3.geoPath())
          .attr("class", "state")
          .on("mouseover", function (event, countyDataItem) {
            tooltip
              .transition()
              .style("visibility", "visible")
              .style("opacity", 0.95)
              .style("left", event.pageX + 10 + "px")
              .style("top", event.pageY - 28 + "px");

            let countyname = countyDataItem["properties"]["name"];
            let countyObj = diseaseDataSubset.find(function (item) {
              return item["County"] === countyname;
            });
            let count = countyObj["Count"];
            let population = countyObj["Population"];
            tooltip.text(countyname + " - " + count + " - " + population);
          })
          .on("mouseout", function (event, countyDataItem) {
            tooltip.transition().style("visibility", "hidden");
          })
          // not binding for some reason :(
          .attr("fill", function (countyDataItem) {
            let countyname = countyDataItem["properties"]["name"];
            let countyObj = diseaseDataSubset.find(function (item) {
              return item["County"] === countyname;
            });
            let count = countyObj["Count"]; 
            return colorScale(count);
          })
          .attr("state", function (countyDataItem) {
            return countyDataItem["properties"]["name"];
          })
          .attr("value", function (countyDataItem) {
            let countyname = countyDataItem["properties"]["name"];
            let countyObj = diseaseDataSubset.find(function (item) {
              return item["County"] === countyname;
            });
            let count = countyObj["Count"];
            return colorScale(count);
          });
      }

      // legend
      legends
        .append("g")
        .attr("class", "legend")
        // .attr("transform", "translate(" + 50 + "," + 30 + ")");
        .attr("transform", "translate(100,100), rotate(-90)");

      var legend = d3
        .legendColor()
        .labels(labels)
        // .title("Value")
        .scale(colorScale);

      legends.select(".legend").call(legend);

      let countyData; // data for drawing counties
      let californiaData; // data for drawing california counties

      let diseaseData; // infectious disease csv data
      let diseaseDataSubset; // subset of disease data

      let selectedDisease; // selected infectious disease type
      let selectedYear; // selected year

      // loading data
      d3.json("dataset/topojson/counties-albers-10m.json").then(function (
        data,
        error
      ) {
        if (error) {
          console.log(log);
        } else {
          // converts topojson into geojson format
          countyData = topojson.feature(data, data.objects.counties).features;

          // california county fips code (from california-fips.csv)
          californiaCountyList = [
            "06001",
            "06003",
            "06005",
            "06007",
            "06009",
            "06011",
            "06013",
            "06015",
            "06017",
            "06019",
            "06021",
            "06023",
            "06025",
            "06027",
            "06029",
            "06031",
            "06033",
            "06035",
            "06037",
            "06039",
            "06041",
            "06043",
            "06045",
            "06047",
            "06049",
            "06051",
            "06053",
            "06055",
            "06057",
            "06059",
            "06061",
            "06063",
            "06065",
            "06067",
            "06069",
            "06071",
            "06073",
            "06075",
            "06077",
            "06079",
            "06081",
            "06083",
            "06085",
            "06087",
            "06089",
            "06091",
            "06093",
            "06095",
            "06097",
            "06099",
            "06101",
            "06103",
            "06105",
            "06107",
            "06109",
            "06111",
            "06113",
            "06115",
          ];

          // california in geojson
          californiaData = [];
          for (var i = 0; i < Object.keys(countyData).length; i++) {
            if (californiaCountyList.includes(countyData[i]["id"])) {
              californiaData.push(countyData[i]);
            }
          }

          d3.csv("dataset/infectious-disease-2001-2014/rows.csv").then(
            function (data, error) {
              if (error) {
                console.log(log);
              } else {
                diseaseData = data;

                // initial state
                selectedDisease = "Amebiasis";
                selectedYear = "2014";

                diseaseDataSubset = diseaseData.filter(function (item) {
                  return (
                    item["County"] !== "California" &&
                    item["Disease"] === selectedDisease &&
                    item["Year"] === selectedYear &&
                    item["Sex"] === "Total" // both female and male
                  );
                });

                setNewColorScale();
                drawMap();
              }
            }
          );
        }
      });

      // drop down selection (disease)
      d3.select("#qDisease").on("change", function (event, d) {
        d3.selectAll("path").remove();
        selectedDisease = document.getElementById("qDisease").value;

        diseaseDataSubset = diseaseData.filter(function (item) {
          return (
            item["County"] !== "California" &&
            item["Disease"] === selectedDisease &&
            item["Year"] === selectedYear &&
            item["Sex"] === "Total" // both female and male
          );
        });
        
        setNewColorScale();
        drawMap();
      });

      // drop down selection (year)
      d3.select("#qYear").on("change", function (event, d) {
        d3.selectAll("path").remove();
        selectedYear = document.getElementById("qYear").value;

        diseaseDataSubset = diseaseData.filter(function (item) {
          return (
            item["Disease"] === selectedDisease &&
            item["Year"] === selectedYear &&
            item["Sex"] === "Total" // both female and male
          );
        });

        setNewColorScale();
        drawMap();
      });

      function setNewColorScale() {
        let min = 0;
        let max = d3.max(
          diseaseDataSubset.map(function (d) {
            return +d.Count;
          })
        );
        let mid = (min + max) / 2;
        let mid25 = (min + mid) / 2;
        let mid75 = (mid + max) / 2;
        domain = [min, mid25, mid, mid75, max];
        // range = [];

        // for (var i=0; i < domain.length; i++) {
        //   range.push(domain[i].toString());
        // }
        
        console.log(diseaseDataSubset)
        colorScale = d3.scaleThreshold().domain(domain).range(range);
        console.log(domain)
      }

    </script>
  </body>
</html>
